<th:block th:fragment="productsTable" xmlns:th="http://www.thymeleaf.org">
    <table class="wa-zebra-rows wa-hover-rows">
        <thead>
        <tr>
            <th>
                <span class="th-with-icon">
                    <wa-icon name="list-ol"></wa-icon>
                    <span th:text="#{table.num}"></span>
                </span>
            </th>
            <th>
                <span class="th-with-icon">
                    <wa-icon name="hashtag"></wa-icon>
                    <span th:text="#{table.ID}"></span>
                </span>
            </th>
            <th>
                <span class="th-with-icon">
                    <wa-icon name="align-left"></wa-icon>
                    <span th:text="#{table.Title}"></span>
                </span>
            </th>
            <th>
                <span class="th-with-icon">
                    <wa-icon name="user"></wa-icon>
                    <span th:text="#{table.Vendor}"></span>
                </span>
            </th>
            <th>
                <span class="th-with-icon">
                    <wa-icon name="tag"></wa-icon>
                    <span th:text="#{table.ProductType}"></span>
                </span>
            </th>
            <th>
                <span class="th-with-icon">
                    <wa-icon name="dollar-sign"></wa-icon>
                    <span th:text="#{table.Price}"></span>
                </span>
            </th>
            <th>
                <span class="th-with-icon">
                    <wa-icon name="screwdriver-wrench"></wa-icon>
                    <span th:text="#{table.actions}"></span>
                </span>
            </th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="product, iterStat : ${products}">
            <td th:text="${iterStat.index + 1}"></td>
            <td th:text="${product.id}"></td>
            <td th:text="${product.title}"></td>
            <td th:text="${product.vendor}"></td>
            <td th:text="${product.productType}"></td>
            <td th:text="${product.price}"></td>
            <td>
                <div class="action-buttons">
                    <a th:href="@{/products/{id}/edit(id=${product.id})}" style="text-decoration: none;">
                        <wa-button variant="neutral" size="small" appearance="filled-outlined">
                            <wa-icon slot="start" name="pen-to-square"></wa-icon>
                            <span th:text="#{form.edit}"></span>
                        </wa-button>
                    </a>
                    <wa-button variant="danger" size="small" appearance="accent" type="button"
                               th:attr="data-id=${product.id}"
                               onclick="window.openDeleteDialog(this)">
                        <wa-icon slot="start" name="trash"></wa-icon>
                        <span th:text="#{delete.button}"></span>
                    </wa-button>
                </div>
            </td>
        </tr>
        </tbody>
    </table>
</th:block>

<div th:fragment="productsTableWithButton" xmlns:th="http://www.thymeleaf.org" xmlns:hx-on="http://www.w3.org/1999/xhtml">
    <div class="toolbar wa-cluster wa-gap-s toolbar-block wa-flank:end">
        <div class="wa-cluster wa-gap-s">
            <wa-animation name="bounce" easing="ease-in-out" duration="2000" play>
                <wa-button class="add-product-btn" variant="success" size="medium" type="button" onclick="openAddDialog()">
                    <wa-icon slot="start" name="plus"></wa-icon>
                    <span th:text="#{form.addProduct}"></span>
                </wa-button>
            </wa-animation>
        </div>
        <div class="wa-cluster wa-gap-2xs wa-align-items-center">
            <wa-button class="sort-btn" variant="success" size="small" appearance="filled" type="button"
                       hx-get="/products/load?sort=price_asc"
                       hx-target="#productsContainer"
                       hx-swap="innerHTML">
                <wa-icon slot="start" name="arrow-down" animation="beat"></wa-icon>
                <span th:text="#{sort.byLowerPrice}"></span>
            </wa-button>
            <wa-button class="sort-btn" variant="danger" size="small" appearance="filled" type="button"
                       hx-get="/products/load?sort=price_desc"
                       hx-target="#productsContainer"
                       hx-swap="innerHTML">
                <wa-icon slot="start" name="arrow-up" animation="beat"></wa-icon>
                <span th:text="#{sort.byHigherPrice}"></span>
            </wa-button>
        </div>
    </div>

    <th:block th:replace="~{this :: productsTable}"></th:block>

    <wa-dialog id="addProductDialog" label="Add Product" light-dismiss>
        <form id="addProductForm"
              hx-post="/products/add"
              hx-target="#productsContainer"
              hx-swap="innerHTML"
              hx-on::after-request="if(event.detail.successful) closeAddDialog()">
            <wa-callout variant="primary" open>
                <span th:text="#{form.addSubtitle}"></span>
            </wa-callout>
            <wa-divider></wa-divider>
            <wa-card>
                <div class="edit-form-grid wa-grid">
                    <wa-input name="id" type="number" th:label="#{form.id}" placeholder="ID" required min="1" size="medium" appearance="outlined">
                        <wa-icon slot="start" name="hashtag"></wa-icon>
                    </wa-input>
                    <wa-input name="title" th:label="#{form.title}" placeholder="Title" required size="medium" appearance="outlined">
                        <wa-icon slot="start" name="align-left"></wa-icon>
                    </wa-input>
                </div>
                <div class="edit-form-grid wa-grid">
                    <wa-input name="vendor" th:label="#{form.vendor}" placeholder="Vendor" required size="medium" appearance="outlined">
                        <wa-icon slot="start" name="user"></wa-icon>
                    </wa-input>
                    <wa-input name="productType" th:label="#{form.type}" placeholder="Type" required size="medium" appearance="outlined">
                        <wa-icon slot="start" name="tag"></wa-icon>
                    </wa-input>
                </div>
                <wa-input name="price" type="number" th:label="#{form.price}" placeholder="Price" required min="0.01" step="0.01" size="medium" appearance="outlined">
                    <wa-icon slot="start" name="dollar-sign"></wa-icon>
                </wa-input>
            </wa-card>
        </form>
        <wa-button slot="footer" variant="neutral" onclick="closeAddDialog()">Cancel</wa-button>
        <wa-button slot="footer" type="submit" variant="success" form="addProductForm">Add Product</wa-button>
    </wa-dialog>

    <wa-dialog id="deleteProductDialog" th:attr="aria-label=#{delete.dialogTitle}" light-dismiss>
        <p th:text="#{delete.confirmMessage}"></p>
        <wa-button slot="footer" variant="neutral" onclick="window.closeDeleteDialog()" th:text="#{nav.cancel}"></wa-button>
        <wa-button slot="footer" variant="danger" type="button" id="deleteProductConfirmBtn" onclick="window.confirmDelete()" th:text="#{delete.confirm}"></wa-button>
    </wa-dialog>

    <script>
        function openAddDialog() {
            document.getElementById('addProductDialog').open = true;
        }
        function closeAddDialog() {
            document.getElementById('addProductDialog').open = false;
        }
        document.body.addEventListener('htmx:afterSwap', function(evt) {
            if (evt.detail.target.id === 'productsContainer') closeAddDialog();
        });

        window.deleteProductId = null;
        window.deleteTargetId = 'productsContainer';
        window.openDeleteDialog = function(btn) {
            window.deleteProductId = btn.getAttribute('data-id');
            var container = btn.closest('[id]');
            window.deleteTargetId = container ? container.id : 'productsContainer';
            var dialog = document.getElementById('deleteProductDialog');
            if (dialog) dialog.open = true;
        };
        window.closeDeleteDialog = function() {
            var dialog = document.getElementById('deleteProductDialog');
            if (dialog) dialog.open = false;
        };
        window.confirmDelete = function() {
            if (!window.deleteProductId) return;
            var isSearch = (window.deleteTargetId === 'searchResults');
            var url = '/products/' + window.deleteProductId + '/delete?target=' + (isSearch ? 'search' : 'main');
            htmx.ajax('POST', url, { target: '#' + window.deleteTargetId, swap: 'innerHTML' })
                .then(function() { window.closeDeleteDialog(); });
        };
    </script>
</div>